<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Breakout Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        #game-container {
            position: relative;
            width: 600px;
            height: 500px;
            margin: 0 auto;
            background-color: #fff;
            border: 2px solid #333;
            overflow: hidden;
        }

        #paddle {
            position: absolute;
            width: 80px;
            height: 20px;
            background-color: #3498db;
            bottom: 10px;
            left: 250px;
            border-radius: 0;
            border: 1px solid #2980b9;
            clip-path: polygon(0% 0%, 100% 0%, 80% 100%, 20% 100%);
        }

        .block {
            position: absolute;
            width: 60px;
            height: 30px;
            background-color: #2ecc71;
            /* Green for regular/easy blocks */
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            border: 1px solid #27ae60;
        }

        .block.hard {
            background-color: #e74c3c;
            /* Red for hard problem blocks */
            border: 1px solid #c0392b;
        }

        .ball {
            position: absolute;
            width: 18px;
            height: 18px;
            background-color: #2ecc71;
            border-radius: 50%;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
        }

        #answer-input {
            width: 100px;
            padding: 8px;
            font-size: 16px;
            margin-top: 15px;
            text-align: center;
            border: 2px solid #3498db;
            border-radius: 5px;
        }

        #score-container {
            margin-top: 10px;
            font-size: 18px;
            font-weight: bold;
        }

        #message {
            margin-top: 10px;
            font-size: 18px;
            height: 25px;
            color: #27ae60;
        }

        #game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            display: none;
            flex-direction: column;
            align-items: center;
            width: 70%;
        }

        button {
            background-color: #3498db;
            border: none;
            color: white;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            margin-top: 15px;
        }

        button:hover {
            background-color: #2980b9;
        }
    </style>
</head>

<body>
    <h1>Math Breakout Game</h1>
    <p>Use left and right arrow keys to move the shooter. Type the answer to a math problem and hit Enter to shoot at
        it.</p>
    <p><span style="color: #2ecc71;">Green blocks</span> have easy problems (single-digit addition/subtraction). <span
            style="color: #e74c3c;">Red blocks</span> have harder problems (2-digit operations or multiplication) worth
        more points!</p>
    <p>Special feature: Answering a red block correctly shoots three balls in different directions!</p>
    <div id="game-container">
        <div id="paddle"></div>
        <div id="game-over">
            <h2>Game Over!</h2>
            <p>Your score: <span id="final-score">0</span></p>
            <button id="restart-button">Play Again</button>
        </div>
    </div>
    <div>
        <input type="number" id="answer-input" placeholder="Answer">
    </div>
    <div id="message"></div>
    <div id="score-container">Score: <span id="score">0</span></div>

    <script>
        // Game controller
        const game = {
            // Game state
            columns: 8,
            rows: 5,
            grid: [],
            blocks: [],
            balls: [],
            score: 0,
            gameInProgress: true,
            paddleX: 250,
            paddleSpeed: 15,

            // DOM elements
            container: document.getElementById('game-container'),
            paddle: document.getElementById('paddle'),
            answerInput: document.getElementById('answer-input'),
            scoreElement: document.getElementById('score'),
            messageElement: document.getElementById('message'),
            gameOverElement: document.getElementById('game-over'),
            finalScoreElement: document.getElementById('final-score'),

            // Initialize the game
            init: function () {
                // Initialize grid
                this.grid = Array(this.columns).fill().map(() => Array(this.rows).fill(null));

                // Set up event listeners
                document.addEventListener('keydown', this.handleKeyPress.bind(this));
                this.answerInput.addEventListener('keydown', this.handleAnswer.bind(this));
                document.getElementById('restart-button').addEventListener('click', this.restart.bind(this));

                // Create initial blocks
                this.createBlocks();

                // Focus on input
                this.answerInput.focus();

                // Start game loop
                this.gameLoop();
            },

            createBlocks: function () {
                // Constants for block layout
                const blockWidth = 60;
                const blockHeight = 30;
                const gameWidth = this.container.offsetWidth;
                const totalBlocksWidth = blockWidth * this.columns;
                const horizontalMargin = (gameWidth - totalBlocksWidth) / 2;
                const horizontalGap = 3;
                const verticalSpacing = 3;

                for (let col = 0; col < this.columns; col++) {
                    for (let row = 0; row < this.rows; row++) {
                        // Create block data
                        const block = {
                            column: col,
                            row: row,
                            x: horizontalMargin + (col * (blockWidth + horizontalGap)),
                            y: (row + 1) * verticalSpacing + row * blockHeight + 30,
                            width: blockWidth,
                            height: blockHeight,
                            hasMathProblem: (row === this.rows - 1), // Bottom row has math problems
                            element: null
                        };

                        // Create and assign a math problem if needed
                        if (block.hasMathProblem) {
                            // Determine difficulty - 25% chance of a hard problem in the bottom row
                            const difficulty = (Math.random() < 0.25) ? 'hard' : 'easy';
                            block.mathProblem = this.createMathProblem(difficulty);
                        }

                        // Create DOM element
                        const element = document.createElement('div');
                        element.className = 'block';
                        element.style.left = block.x + 'px';
                        element.style.top = block.y + 'px';

                        if (block.hasMathProblem) {
                            element.textContent = block.mathProblem.expression;

                            // Add 'hard' class for styling if it's a hard problem
                            if (block.mathProblem.difficulty === 'hard') {
                                element.classList.add('hard');
                            }
                        }

                        // Add to DOM
                        this.container.appendChild(element);

                        // Store element reference
                        block.element = element;

                        // Store in grid and blocks array
                        this.grid[col][row] = block;
                        this.blocks.push(block);
                    }
                }
            },

            createMathProblem: function (difficulty = 'easy') {
                if (difficulty === 'easy') {
                    // Create a simple math problem suitable for a 7-year-old
                    if (Math.random() < 0.5) {
                        // Addition
                        const num1 = Math.floor(Math.random() * 10) + 1; // 1-10
                        const num2 = Math.floor(Math.random() * 10) + 1; // 1-10
                        return {
                            expression: `${num1} + ${num2}`,
                            answer: num1 + num2,
                            difficulty: 'easy'
                        };
                    } else {
                        // Subtraction - ensure result is positive
                        const num2 = Math.floor(Math.random() * 10) + 1; // 1-10
                        const num1 = num2 + Math.floor(Math.random() * 10); // Ensure num1 > num2
                        return {
                            expression: `${num1} - ${num2}`,
                            answer: num1 - num2,
                            difficulty: 'easy'
                        };
                    }
                } else {
                    // Hard problems: 2-digit operations or multiplication
                    const type = Math.random() < 0.6 ? "multiplication" : "2digit";

                    if (type === "2digit") {
                        // 2-digit addition or subtraction
                        const isAddition = Math.random() < 0.5;
                        if (isAddition) {
                            const num1 = Math.floor(Math.random() * 90) + 10; // 10-99
                            const num2 = Math.floor(Math.random() * 90) + 10; // 10-99
                            return {
                                expression: `${num1} + ${num2}`,
                                answer: num1 + num2,
                                difficulty: 'hard'
                            };
                        } else {
                            // Subtraction with positive result
                            const num2 = Math.floor(Math.random() * 90) + 10; // 10-99
                            const num1 = num2 + Math.floor(Math.random() * 90) + 10; // Ensure num1 > num2
                            return {
                                expression: `${num1} - ${num2}`,
                                answer: num1 - num2,
                                difficulty: 'hard'
                            };
                        }
                    } else {
                        // Multiplication up to 12x12
                        const num1 = Math.floor(Math.random() * 12) + 1; // 1-12
                        const num2 = Math.floor(Math.random() * 12) + 1; // 1-12
                        return {
                            expression: `${num1} × ${num2}`,
                            answer: num1 * num2,
                            difficulty: 'hard'
                        };
                    }
                }
            },

            // Find the lowest block in a specific column
            getLowestBlockInColumn: function (column) {
                for (let row = this.rows - 1; row >= 0; row--) {
                    if (this.grid[column][row] !== null) {
                        return this.grid[column][row];
                    }
                }
                return null;
            },

            // Check if any block in the grid has a math problem
            hasAnyMathProblems: function () {
                return this.blocks.some(block => block.hasMathProblem);
            },

            // Ensure the lowest block in each column has a math problem
            updateMathProblems: function () {
                // Clear all existing math problems
                this.blocks.forEach(block => {
                    if (block.hasMathProblem) {
                        block.hasMathProblem = false;
                        block.mathProblem = null;
                        block.element.textContent = '';
                        // Remove hard styling if it was there
                        block.element.classList.remove('hard');
                    }
                });

                // Assign math problems to the lowest block in each column
                for (let col = 0; col < this.columns; col++) {
                    const lowestBlock = this.getLowestBlockInColumn(col);
                    if (lowestBlock) {
                        lowestBlock.hasMathProblem = true;

                        // 25% chance of a hard problem
                        const difficulty = (Math.random() < 0.25) ? 'hard' : 'easy';
                        lowestBlock.mathProblem = this.createMathProblem(difficulty);
                        lowestBlock.element.textContent = lowestBlock.mathProblem.expression;

                        // Add visual styling for hard problems
                        if (lowestBlock.mathProblem.difficulty === 'hard') {
                            lowestBlock.element.classList.add('hard');
                        }
                    }
                }
            },

            // Remove a block from the game
            removeBlock: function (block) {
                // Remove from DOM
                if (block.element && block.element.parentNode) {
                    block.element.parentNode.removeChild(block.element);
                }

                // Remove from grid
                this.grid[block.column][block.row] = null;

                // Remove from blocks array
                const blockIndex = this.blocks.indexOf(block);
                if (blockIndex !== -1) {
                    this.blocks.splice(blockIndex, 1);
                }

                // Check if we need to update math problems
                if (block.hasMathProblem) {
                    this.updateMathProblems();
                }

                // Check if all blocks are cleared
                if (this.blocks.length === 0) {
                    this.showVictory();
                }
            },

            // Handle keyboard input for paddle movement
            handleKeyPress: function (e) {
                if (!this.gameInProgress) return;

                if (e.key === 'ArrowLeft') {
                    this.paddleX -= this.paddleSpeed;
                    if (this.paddleX < 0) {
                        this.paddleX = 0;
                    }
                    this.paddle.style.left = this.paddleX + 'px';
                } else if (e.key === 'ArrowRight') {
                    this.paddleX += this.paddleSpeed;
                    if (this.paddleX > this.container.offsetWidth - this.paddle.offsetWidth) {
                        this.paddleX = this.container.offsetWidth - this.paddle.offsetWidth;
                    }
                    this.paddle.style.left = this.paddleX + 'px';
                }
            },

            // Create a ball with specific trajectory
            shootBall: function (x, y, directionX, directionY) {
                const ball = {
                    x: x - 9, // Center the 18px ball
                    y: y,
                    speedX: directionX * 5, // Speed multiplier
                    speedY: directionY * 5,
                    width: 18,
                    height: 18,
                    element: null
                };

                // Create DOM element
                const element = document.createElement('div');
                element.className = 'ball';
                element.style.left = ball.x + 'px';
                element.style.top = ball.y + 'px';

                // Add to DOM
                this.container.appendChild(element);

                // Store element reference
                ball.element = element;

                // Add to balls array
                this.balls.push(ball);

                return ball;
            },

            // Shoot multiple balls in different directions (for hard problems)
            shootMultipleBalls: function (x, y, targetX, targetY) {
                // Calculate trajectory to target
                const deltaX = targetX - x;
                const deltaY = targetY - y;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

                // Normalize direction vectors
                const dirX = deltaX / distance;
                const dirY = deltaY / distance;

                // Ball 1: Straight up
                this.shootBall(x, y, 0, -1);

                // Ball 2: Toward target
                this.shootBall(x, y, dirX, dirY);

                // Ball 3: Mirror angle (reflect horizontally)
                this.shootBall(x, y, -dirX, dirY);
            },

            // Handle math answer input
            handleAnswer: function (e) {
                if (e.key !== 'Enter') return;

                const userAnswer = parseInt(this.answerInput.value);
                if (isNaN(userAnswer)) {
                    this.showMessage("Please enter a number", "red");
                    return;
                }

                // Check if any block with a math problem matches the answer
                let correctBlock = null;
                for (const block of this.blocks) {
                    if (block.hasMathProblem && block.mathProblem.answer === userAnswer) {
                        correctBlock = block;
                        break;
                    }
                }

                if (correctBlock) {
                    // Get positions for shooting the ball
                    const paddleCenterX = this.paddleX + this.paddle.offsetWidth / 2;
                    const paddleTopY = this.container.offsetHeight - this.paddle.offsetHeight - 15;

                    // Get target position (center of the block)
                    const blockCenterX = correctBlock.x + correctBlock.width / 2;
                    const blockCenterY = correctBlock.y + correctBlock.height / 2;

                    // Check if it's a hard problem to determine shooting mode
                    if (correctBlock.mathProblem.difficulty === 'hard') {
                        // Hard problems shoot 3 balls
                        this.shootMultipleBalls(paddleCenterX, paddleTopY, blockCenterX, blockCenterY);
                    } else {
                        // Easy problems shoot 1 ball
                        // Calculate trajectory
                        const deltaX = blockCenterX - paddleCenterX;
                        const deltaY = blockCenterY - paddleTopY;
                        const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

                        // Create the ball
                        this.shootBall(paddleCenterX, paddleTopY, deltaX / distance, deltaY / distance);
                    }

                    // Award more points for hard problems
                    const pointsValue = correctBlock.mathProblem.difficulty === 'hard' ? 50 : 20;

                    // Remove the block
                    this.removeBlock(correctBlock);

                    // Update score
                    this.score += pointsValue;
                    this.scoreElement.textContent = this.score;

                    this.showMessage(`Correct! +${pointsValue} points`, "green");
                } else {
                    this.showMessage("Try again!", "red");
                    // Penalty
                    this.score = Math.max(0, this.score - 5);
                    this.scoreElement.textContent = this.score;
                }

                // Clear input and focus
                this.answerInput.value = '';
                this.answerInput.focus();
            },

            // Move all balls and check for collisions
            moveBalls: function () {
                const containerWidth = this.container.offsetWidth;
                const containerHeight = this.container.offsetHeight;

                for (let i = this.balls.length - 1; i >= 0; i--) {
                    const ball = this.balls[i];

                    // Store previous position
                    const prevX = ball.x;
                    const prevY = ball.y;

                    // Calculate new position
                    ball.x += ball.speedX;
                    ball.y += ball.speedY;

                    // Wall collisions
                    if (ball.x <= 0 || ball.x + ball.width >= containerWidth) {
                        ball.speedX = -ball.speedX;
                        // Adjust to prevent sticking
                        if (ball.x <= 0) {
                            ball.x = 1;
                        } else {
                            ball.x = containerWidth - ball.width - 1;
                        }
                    }

                    if (ball.y <= 0) {
                        ball.speedY = -ball.speedY;
                        ball.y = 1; // Prevent sticking
                    }

                    // Out of bounds
                    if (ball.y >= containerHeight) {
                        // Remove ball
                        if (ball.element && ball.element.parentNode) {
                            ball.element.parentNode.removeChild(ball.element);
                        }
                        this.balls.splice(i, 1);
                        continue;
                    }

                    // Update element position
                    ball.element.style.left = ball.x + 'px';
                    ball.element.style.top = ball.y + 'px';

                    // Check for block collisions
                    let collided = false;
                    for (let j = this.blocks.length - 1; j >= 0; j--) {
                        const block = this.blocks[j];

                        // Check collision with expanded hitbox (less likely to go through gaps)
                        if (
                            ball.x + ball.width + 2 >= block.x &&
                            ball.x - 2 <= block.x + block.width &&
                            ball.y + ball.height + 2 >= block.y &&
                            ball.y - 2 <= block.y + block.height
                        ) {
                            // Determine collision side based on previous position
                            // Horizontal collision
                            if ((prevX + ball.width < block.x && ball.x + ball.width >= block.x) ||
                                (prevX > block.x + block.width && ball.x <= block.x + block.width)) {
                                ball.speedX = -ball.speedX;
                            }
                            // Vertical collision
                            else if ((prevY + ball.height < block.y && ball.y + ball.height >= block.y) ||
                                (prevY > block.y + block.height && ball.y <= block.y + block.height)) {
                                ball.speedY = -ball.speedY;
                            }
                            // Corner or ambiguous collision
                            else {
                                // Determine based on direction of approach
                                const dx = (ball.x + ball.width / 2) - (block.x + block.width / 2);
                                const dy = (ball.y + ball.height / 2) - (block.y + block.height / 2);

                                if (Math.abs(dx) > Math.abs(dy)) {
                                    ball.speedX = -ball.speedX;
                                } else {
                                    ball.speedY = -ball.speedY;
                                }
                            }

                            // Update score
                            this.score += 10;
                            this.scoreElement.textContent = this.score;

                            // Remove the block
                            this.removeBlock(block);

                            // Only handle one collision per frame
                            collided = true;
                            break;
                        }
                    }

                    // Adjust position after collision to prevent getting stuck
                    if (collided) {
                        ball.x += ball.speedX * 0.5;
                        ball.y += ball.speedY * 0.5;
                        ball.element.style.left = ball.x + 'px';
                        ball.element.style.top = ball.y + 'px';
                    }
                }
            },

            showMessage: function (text, color) {
                this.messageElement.textContent = text;
                this.messageElement.style.color = color;

                setTimeout(() => {
                    this.messageElement.textContent = '';
                }, 2000);
            },

            showVictory: function () {
                this.gameInProgress = false;
                this.gameOverElement.style.display = 'flex';
                this.finalScoreElement.textContent = this.score;
                document.querySelector('#game-over h2').textContent = "Victory!";
            },

            gameLoop: function () {
                if (this.gameInProgress) {
                    this.moveBalls();

                    // Ensure there are always math problems on the lowest blocks
                    if (!this.hasAnyMathProblems() && this.blocks.length > 0) {
                        this.updateMathProblems();
                    }
                }
                requestAnimationFrame(this.gameLoop.bind(this));
            },

            restart: function () {
                // Clear game elements
                while (this.container.firstChild) {
                    if (this.container.firstChild !== this.paddle && this.container.firstChild !== this.gameOverElement) {
                        this.container.removeChild(this.container.firstChild);
                    }
                }

                // Reset game state
                this.grid = Array(this.columns).fill().map(() => Array(this.rows).fill(null));
                this.blocks = [];
                this.balls = [];
                this.score = 0;
                this.scoreElement.textContent = '0';
                this.gameInProgress = true;
                this.gameOverElement.style.display = 'none';
                this.messageElement.textContent = '';

                // Initialize again
                this.createBlocks();

                // Focus on input
                this.answerInput.value = '';
                this.answerInput.focus();
            }
        };

        // Initialize game
        game.init();
    </script>
</body>

</html>